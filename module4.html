<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WayFrame | Accommodation</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
  <style>
    body { background:#f5f7fb; }
    .card { border-radius:16px; }
    .badge-dest {
      background:#eef5ff; color:#0b5ed7; border:1px solid #cfe2ff;
      padding:.4rem .6rem; border-radius:999px; font-weight:600;
    }
    .muted { color:#6b7280; }
    .range-value { font-weight:700; padding:0 .25rem; }
    .divider { height:1px; background:#e9ecef; margin:1rem 0; }
    .source-note { font-size:.8rem; color:#6b7280; }
  </style>
</head>
<body class="bg-light">

  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-12 col-md-8 col-lg-6">
        <div class="card shadow p-4">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 mb-0">Pick Your Accommodation</h2>
            <span id="destBadge" class="badge-dest d-none"></span>
          </div>
          <p class="muted mb-2" id="destHint"></p>
          <p class="source-note mb-3">
            Accommodation data will reference the
            <a href="https://tourism.gov.ph/accreditations/accredited" target="_blank" rel="noopener">Department of Tourism accredited list</a>.
          </p>
          <div class="divider"></div>

          <form id="accomForm" novalidate>
            <!-- Accommodation Type -->
            <div class="mb-3">
              <label for="accommodationType" class="form-label">Accommodation Type</label>
              <select id="accommodationType" class="form-select" required>
                <option value="" selected disabled>Choose type...</option>
                <option>Hotel</option>
                <option>Resort</option>
                <option>Hostel</option>
                <option>Guesthouse</option>
                <option>BnB</option>
                <option>AirBnB</option>
                <option>Motel</option>
                <option>Campsite</option>
                <option>Apartment Hotel</option>
              </select>
              <div class="invalid-feedback">Please choose a type.</div>
            </div>

            <!-- Price Range -->
            <div class="mb-3">
              <label for="priceRange" class="form-label">Price (max per night)</label>
              <input type="range" class="form-range" min="500" max="10000" step="100" id="priceRange" value="3500">
              <div class="d-flex justify-content-between small">
                <span>₱500</span>
                <span>Selected: <span class="range-value" id="priceValue">₱3,500</span></span>
                <span>₱10,000+</span>
              </div>
            </div>

            <!-- Room Size -->
            <div class="mb-3">
              <label for="roomSize" class="form-label">Preferred Room Size</label>
              <select id="roomSize" class="form-select" required>
                <option value="" selected disabled>Select room size...</option>
                <option>Single</option>
                <option>Double</option>
                <option>Family Room</option>
                <option>Suite</option>
              </select>
              <div class="invalid-feedback">Please choose a room size.</div>
            </div>

            <!-- Bed Count -->
            <div class="mb-4">
              <label for="bedCount" class="form-label">Number of Beds Needed</label>
              <input type="number" class="form-control" id="bedCount" min="1" max="10" value="1" required/>
              <div class="invalid-feedback">Please enter between 1 and 10 beds.</div>
            </div>

            <!-- Actions -->
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary btn-lg">See Available Stays</button>
            </div>
          </form>

          <div class="text-center mt-3">
            <a href="module2.html" class="text-decoration-none small">← Change destination</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIG ---
    const RESULTS_PAGE = 'stays.html'; // your results listing page

    // --- Guard: must have Module 1 + Module 2 destination ---
    (function guard(){
      const name = localStorage.getItem('userName');
      const email = localStorage.getItem('userEmail');
      if (!name || !email) {
        alert('Please start at the beginning.');
        window.location.href = 'index.html';
        return;
      }
      const dest = JSON.parse(localStorage.getItem('wf_destination') || '{}');
      if (!dest || (!dest.city && !(dest.lat && dest.lng))) {
        alert('Please select a destination first.');
        window.location.href = 'module2.html';
        return;
      }
    })();

    // --- Destination badge/header ---
    (function showDestination(){
      const dest = JSON.parse(localStorage.getItem('wf_destination') || '{}');
      const badge = document.getElementById('destBadge');
      const hint = document.getElementById('destHint');

      const city = dest.city || 'Your pin';
      const province = dest.province ? `, ${dest.province}` : '';
      const region = dest.region ? `, ${dest.region}` : '';
      const coords = (dest.lat && dest.lng) ? ` (${dest.lat.toFixed(3)}, ${dest.lng.toFixed(3)})` : '';

      badge.textContent = `${city}${province}`;
      badge.classList.remove('d-none');

      hint.textContent = `Planning stays near: ${city}${province}${region}${coords}`;
    })();

    // --- Live price label ---
    const priceInput = document.getElementById('priceRange');
    const priceValue = document.getElementById('priceValue');
    priceInput.addEventListener('input', () => {
      priceValue.textContent = toPeso(priceInput.value);
    });
    function toPeso(n){ return '₱' + Number(n).toLocaleString('en-PH'); }

    // --- Prefill from previous attempt (optional) ---
    (function prefill(){
      const prev = JSON.parse(localStorage.getItem('wf_accomCriteria') || '{}');
      if (!prev) return;
      if (prev.type) document.getElementById('accommodationType').value = prev.type;
      if (prev.maxPrice) {
        priceInput.value = prev.maxPrice;
        priceValue.textContent = toPeso(prev.maxPrice);
      }
      if (prev.roomSize) document.getElementById('roomSize').value = prev.roomSize;
      if (prev.beds) document.getElementById('bedCount').value = prev.beds;
    })();

    // --- Normalize destination.region → DoT dataset keys (e.g., "Region 4A") ---
    function normalizeRegionKey(regionStr=''){
      const s = (regionStr || '').toLowerCase();

      // Common labels → canonical keys
      if (s.includes('ncr') || s.includes('metro manila')) return 'NCR';
      if (s.includes('iv-a') || s.includes('4a') || s.includes('calabarzon')) return 'Region 4A';
      if (s.includes('iv-b') || s.includes('4b') || s.includes('mimaropa')) return 'Region 4B';
      if (s.includes('region 5') || s === 'bicol' || s.includes('bicol')) return 'Region 5';
      if (s.includes('region 6') || s.includes('western visayas')) return 'Region 6';
      if (s.includes('region 7') || s.includes('central visayas')) return 'Region 7';
      if (s.includes('region 12') || s.includes('soccsksargen')) return 'Region 12';

      // Pass-through for already canonical inputs
      if (/^region\s*\d{1,2}[ab]?$/i.test(regionStr.trim())) return regionStr.trim();
      if (regionStr.trim().toUpperCase() === 'NCR') return 'NCR';

      // Fallback: return original (results page can handle nulls)
      return regionStr || null;
    }

    // --- Submit: save filters & computed regionKey, then go to results page ---
    document.getElementById('accomForm').addEventListener('submit', (e) => {
      e.preventDefault();

      const type = document.getElementById('accommodationType').value;
      const maxPrice = parseInt(document.getElementById('priceRange').value, 10);
      const roomSize = document.getElementById('roomSize').value;
      const beds = parseInt(document.getElementById('bedCount').value, 10);

      let valid = true;
      if (!type) { markInvalid('accommodationType'); valid = false; }
      if (!roomSize) { markInvalid('roomSize'); valid = false; }
      if (!(beds >= 1 && beds <= 10)) { markInvalid('bedCount'); valid = false; }

      if (!valid) return;

      const dest = JSON.parse(localStorage.getItem('wf_destination') || '{}');
      const regionKey = normalizeRegionKey(dest.region);

      localStorage.setItem('wf_accomCriteria', JSON.stringify({
        type, maxPrice, roomSize, beds,
        destination: dest,
        regionKey, // <- use this to filter your DoT dataset on the results page
        ts: Date.now()
      }));

      const progress = JSON.parse(localStorage.getItem('wf_progress') || '{}');
      localStorage.setItem('wf_progress', JSON.stringify({ ...progress, m4: true }));

      window.location.href = RESULTS_PAGE;
    });

    function markInvalid(id){
      const el = document.getElementById(id);
      el.classList.add('is-invalid');
      el.addEventListener('input', () => el.classList.remove('is-invalid'), { once:true });
    }
  </script>
</body>
</html>
