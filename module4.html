<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>WayFrame | Available Stays</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
    <style>
      body{background:#f5f7fb}
      .card{border-radius:16px}
      .badge-dot{background:#e9f5eb;color:#237a3b;border:1px solid #cde9d6}
      .pill{background:#eef5ff;color:#0b5ed7;border:1px solid #cfe2ff;border-radius:999px;padding:.25rem .5rem;font-weight:600}
      .muted{color:#6b7280}
      .thumb{width:100%;height:160px;object-fit:cover;border-radius:12px}
      .sticky-top{top:0.75rem !important}
    </style>
  </head>
  <body>
    <div class="container py-3">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div>
          <h1 class="h5 mb-1">Available Stays</h1>
          <div id="destLine" class="muted small"></div>
        </div>
        <a href="module4.html" class="pill text-decoration-none">Edit filters</a>
      </div>
    
      <div class="row g-3">
        <!-- Filters summary / helper -->
        <div class="col-12 col-lg-3">
          <div class="card p-3 sticky-top">
            <div class="fw-semibold mb-2">Your criteria</div>
            <div id="crit" class="small"></div>
            <hr>
            <small class="text-muted">
              Accommodation data sourced from the
              <a href="https://tourism.gov.ph/accreditations/accredited" target="_blank">Philippines Department of Tourism</a>.
            </small>
          </div>
        </div>
    
        <!-- Results -->
        <div class="col-12 col-lg-9">
          <div id="list" class="row g-3"></div>
          <div id="empty" class="text-center text-muted py-5 d-none">No matches. Try widening your price or type.</div>
        </div>
      </div>
    </div>
    
    <script>
      // --- Read context ---
      const dest = JSON.parse(localStorage.getItem('wf_destination') || '{}');
      const crit = JSON.parse(localStorage.getItem('wf_accomCriteria') || '{}');
    
      // Guard
      if (!dest || (!dest.city && !dest.lat)) {
        alert('Please pick a destination first.');
        location.href = 'module2.html';
      }
    
      // Header lines
      const destLine = document.getElementById('destLine');
      destLine.textContent = `Near ${dest.city || 'your pin'}${dest.province ? ', ' + dest.province : ''}${dest.region ? ', ' + dest.region : ''}`;
    
      const critBox = document.getElementById('crit');
      critBox.innerHTML = `
        <div><strong>Type:</strong> ${crit.type || 'Any'}</div>
        <div><strong>Max price:</strong> ${crit.maxPrice ? toPeso(crit.maxPrice) : 'Any'}</div>
        <div><strong>Room size:</strong> ${crit.roomSize || 'Any'}</div>
        <div><strong>Beds:</strong> ${crit.beds || 'Any'}</div>
      `;
    
      // --- Data adapter (swap to n8n webhook later) ---
      async function fetchStays() {
        // V1: local mock. Replace with fetch('https://YOUR-N8N-WEBHOOK') for live.
        // Expected shape per item:
        // { id, name, type, city, province, region, lat, lng, pricePerNight, beds, roomSize, amenities, photoUrl, bookingUrl, contact, dotAccredited:true }
        const data = [
          {
            id:"el-nido-01", name:"Cadlao Resort", type:"Resort", city:"El Nido", province:"Palawan", region:"MIMAROPA",
            lat:11.196, lng:119.406, pricePerNight:4500, beds:2, roomSize:"Double",
            amenities:"Pool; Beachfront; WiFi", photoUrl:"https://images.unsplash.com/photo-1501117716987-c8e1ecb2101f?q=80&w=1200&auto=format&fit=crop",
            bookingUrl:"https://www.cadlaoresort.com/", contact:"+63 912 345 6789", dotAccredited:true
          },
          {
            id:"baguio-01", name:"Hotel Elizabeth", type:"Hotel", city:"Baguio", province:"Benguet", region:"CAR",
            lat:16.418, lng:120.613, pricePerNight:3200, beds:2, roomSize:"Double",
            amenities:"Breakfast; Parking; WiFi", photoUrl:"https://images.unsplash.com/photo-1502920917128-1aa500764b8a?q=80&w=1200&auto=format&fit=crop",
            bookingUrl:"https://www.hotelelizabeth.com.ph/", contact:"+63 74 442 1111", dotAccredited:true
          },
          {
            id:"tagaytay-01", name:"Taal Vista Hotel", type:"Hotel", city:"Tagaytay", province:"Cavite", region:"CALABARZON",
            lat:14.110, lng:120.933, pricePerNight:5800, beds:2, roomSize:"Suite",
            amenities:"View; Pool; WiFi", photoUrl:"https://images.unsplash.com/photo-1488747279002-c8523379faaa?q=80&w=1200&auto=format&fit=crop",
            bookingUrl:"https://www.taalvistahotel.com/", contact:"+63 46 413 1000", dotAccredited:true
          }
        ];
        return data;
      }
    
      // --- Helpers ---
      function toPeso(n){ return '₱' + Number(n).toLocaleString('en-PH'); }
      function haversineKm(a, b){
        if (!a || !b || a.lat==null || a.lng==null || b.lat==null || b.lng==null) return null;
        const R=6371, d2r=Math.PI/180;
        const dLat=(b.lat-a.lat)*d2r, dLng=(b.lng-a.lng)*d2r;
        const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
        const aa=s1*s1 + Math.cos(a.lat*d2r)*Math.cos(b.lat*d2r)*s2*s2;
        return R*2*Math.atan2(Math.sqrt(aa), Math.sqrt(1-aa));
      }
    
      // --- Render ---
      (async function init(){
        const stays = await fetchStays();
    
        // Filter using criteria (type, price, beds, roomSize, and destination proximity if city present)
        const filtered = stays.filter(s => {
          if (crit.type && s.type !== crit.type) return false;
          if (crit.maxPrice && s.pricePerNight && s.pricePerNight > crit.maxPrice) return false;
          if (crit.beds && s.beds && s.beds < crit.beds) return false;
          if (crit.roomSize && s.roomSize && s.roomSize !== crit.roomSize) return false;
    
          // (Optional) If destination city is set, prefer same city; otherwise allow all
          if (dest.city && s.city && s.city.toLowerCase() !== dest.city.toLowerCase()) {
            // keep, but will sort by distance later
          }
          // Only list DOT-accredited (your rule)
          if (s.dotAccredited !== true) return false;
          return true;
        }).map(s => {
          // compute distance if we have coords
          s._distanceKm = (dest.lat && dest.lng && s.lat && s.lng)
            ? haversineKm({lat:dest.lat,lng:dest.lng},{lat:s.lat,lng:s.lng})
            : null;
          return s;
        }).sort((a,b)=>{
          // Sort by distance first (if available), else by price
          if (a._distanceKm!=null && b._distanceKm!=null) return a._distanceKm - b._distanceKm;
          if (a._distanceKm!=null) return -1;
          if (b._distanceKm!=null) return 1;
          return (a.pricePerNight||Infinity) - (b.pricePerNight||Infinity);
        });
    
        renderList(filtered);
      })();
    
      function renderList(items){
        const list = document.getElementById('list');
        const empty = document.getElementById('empty');
        list.innerHTML = '';
    
        if (!items.length){
          empty.classList.remove('d-none');
          return;
        }
        empty.classList.add('d-none');
    
        items.forEach(s => {
          const km = s._distanceKm!=null ? `${s._distanceKm.toFixed(1)} km away` : (s.city ? s.city : '');
          const price = s.pricePerNight ? toPeso(s.pricePerNight) + '/night' : '—';
          const dot = s.dotAccredited ? `<span class="badge badge-dot ms-2">DOT Accredited</span>` : '';
          const photo = s.photoUrl || 'https://via.placeholder.com/800x500?text=WayFrame';
    
          const col = document.createElement('div');
          col.className = 'col-12';
          col.innerHTML = `
            <div class="card p-3">
              <div class="row g-3 align-items-center">
                <div class="col-12 col-md-4">
                  <img class="thumb" src="${photo}" alt="${s.name}">
                </div>
                <div class="col-12 col-md-8">
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <h2 class="h6 mb-0">${s.name}${dot}</h2>
                    <div class="muted small">${km}</div>
                  </div>
                  <div class="small mt-1">${s.type}${s.amenities ? ' • ' + s.amenities : ''}</div>
                  <div class="mt-2 fw-semibold">${price}</div>
                  <div class="d-flex gap-2 mt-3 flex-wrap">
                    ${s.bookingUrl ? `<a class="btn btn-outline-primary btn-sm" href="${s.bookingUrl}" target="_blank" rel="noopener">Check availability</a>` : ''}
                    <button class="btn btn-primary btn-sm" data-id="${s.id}">Add to plan</button>
                  </div>
                  <div class="small muted mt-2">${s.contact ? 'Contact: ' + s.contact : ''}</div>
                </div>
              </div>
            </div>
          `;
          // Add handler for Add to plan
          col.querySelector('button.btn-primary').addEventListener('click', ()=> addToPlan(s));
          list.appendChild(col);
        });
      }
    
      function addToPlan(stay){
        // Store minimal info for Module 6 summary; you can later write to Firestore
        const arr = JSON.parse(localStorage.getItem('wf_stays') || '[]');
        arr.push({
          id: stay.id,
          name: stay.name,
          city: stay.city,
          pricePerNight: stay.pricePerNight || null,
          lat: stay.lat || null,
          lng: stay.lng || null,
          addedAt: Date.now()
        });
        localStorage.setItem('wf_stays', JSON.stringify(arr));
    
        // Mark progress and give lightweight feedback
        const progress = JSON.parse(localStorage.getItem('wf_progress') || '{}');
        localStorage.setItem('wf_progress', JSON.stringify({ ...progress, m4_added: true }));
    
        alert(`Added "${stay.name}" to your plan.`);
      }
    </script>
  </body>
</html>
