<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WayFrame | Available Stays</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f5f7fb}
    .card{border-radius:16px}
    .thumb{height:160px;background:linear-gradient(135deg,#e5ecff,#f5f7fb);border-radius:12px}
    .muted{color:#6b7280}
  </style>
</head>
<body>
<div class="container py-3">

  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h1 class="h5 mb-1">Available Stays</h1>
      <div id="destLine" class="text-muted small"></div>
    </div>
    <a href="module4.html" class="btn btn-outline-primary btn-sm">Edit filters</a>
  </div>

  <div class="row g-3">
    <!-- Sidebar -->
    <div class="col-12 col-lg-3">
      <div class="card p-3 sticky-top">
        <div class="fw-semibold mb-2">Your criteria</div>
        <div id="crit" class="small"></div>
        <hr>
        <small class="text-muted">Establishments are from your curated DOT list in Google Sheets.</small>
        <hr>
        <div class="small"><strong>Selected:</strong> <span id="selCount">0</span> stay(s)</div>
      </div>
    </div>

    <!-- Results -->
    <div class="col-12 col-lg-9">
      <div id="scopeNote" class="alert alert-info py-2 px-3 small d-none"></div>

      <div id="loading" class="text-center text-muted py-5">
        <div class="spinner-border" role="status" aria-hidden="true"></div>
        <div class="mt-2">Loading stays…</div>
      </div>

      <div id="list" class="row g-3 d-none"></div>
      <div id="empty" class="text-center text-muted py-5 d-none">No stays match your destination.</div>
      <div id="errorBox" class="alert alert-danger mt-3 d-none">Couldn’t load stays. Please try again.</div>
    </div>
  </div>
</div>

<script>
  // ---------- CONFIG ----------
  const MAKE_WEBHOOK = "https://tumbletech.app.n8n.cloud/webhook/wayframe/stays"; // <-- n8n webhook here

  // ---------- Destination + Criteria (from prior modules) ----------
  const dest = safeJSON(localStorage.getItem('wf_destination')) || {};
  const crit = safeJSON(localStorage.getItem('wf_accomCriteria')) || {};

  if (!dest || (!dest.city && !(dest.lat && dest.lng))) {
    alert('Please pick a destination first.');
    location.href = 'module2.html';
  }

  document.getElementById('destLine').textContent =
    dest.city
      ? `Near ${dest.city}${dest.province ? ', ' + dest.province : ''}${dest.region ? ', ' + dest.region : ''}`
      : `Near your selected pin (${(dest.lat??0).toFixed?.(3) ?? dest.lat}, ${(dest.lng??0).toFixed?.(3) ?? dest.lng})`;

  document.getElementById('crit').innerHTML = `
    <div><strong>Type:</strong> ${crit.type || 'Any'}</div>
    <div><strong>Max price:</strong> ${crit.maxPrice ? '≤ ₱' + Number(crit.maxPrice).toLocaleString('en-PH') : 'Any'}</div>
    <div><strong>Room size:</strong> ${crit.roomSize || 'Any'}</div>
    <div><strong>Beds:</strong> ${crit.beds || 'Any'}</div>
  `;

  // ---------- Helpers ----------
  function safeJSON(s){ try { return JSON.parse(s); } catch { return null; } }
  function normalizeRegionKey(regionStr=''){
    const s = (regionStr || '').toLowerCase();
    if (s.includes('ncr') || s.includes('metro manila')) return 'NCR';
    if (s.includes('iv-a') || s.includes('4a') || s.includes('calabarzon')) return 'Region 4A';
    if (s.includes('iv-b') || s.includes('4b') || s.includes('mimaropa')) return 'Region 4B';
    if (s.includes('region 5') || s.includes('bicol')) return 'Region 5';
    if (s.includes('region 6') || s.includes('western visayas')) return 'Region 6';
    if (s.includes('region 7') || s.includes('central visayas')) return 'Region 7';
    if (s.includes('region 12') || s.includes('soccsksargen')) return 'Region 12';
    if (/^region\s*\d{1,2}[ab]?$/i.test(regionStr?.trim())) return regionStr.trim();
    if ((regionStr||'').trim().toUpperCase() === 'NCR') return 'NCR';
    return regionStr || null;
  }
  const regionKey = crit.regionKey || normalizeRegionKey(dest.region);

  const note = document.getElementById('scopeNote');
  if (regionKey) {
    note.classList.remove('d-none');
    note.textContent = `Showing establishments in ${regionKey}.`;
  }

  // ---------- Fetch from Make (expects JSON array) ----------
  (async function loadStays(){
    const loading = document.getElementById('loading');
    const errorBox = document.getElementById('errorBox');

    try{
      const url = new URL(MAKE_WEBHOOK);
      if (regionKey) url.searchParams.set('region', regionKey);
      if (crit.type) url.searchParams.set('type', crit.type);

      const res = await fetch(url.toString(), { method:'GET' });

      // If your Make response is correctly set to application/json, this will work:
      let rows;
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) {
        rows = await res.json();
      } else {
        // Fallback: try to parse text that might actually be a JSON string
        const txt = await res.text();
        rows = safeJSON(txt);
      }

      if (!res.ok || !Array.isArray(rows)) throw new Error('Bad response');

      // Map incoming fields gracefully
      const items = rows.map(r => ({
        region: r.Region ?? r.region ?? '',
        name: r['Hotel Name'] ?? r.name ?? '',
        rating: r.Rating ?? r.rating ?? '',
        category: r.Category ?? r.category ?? '',
        validity: r.Validity ?? r.validity ?? '',
        website: r.Website ?? r.website ?? '',
        bookingUrl: r['Booking URL'] ?? r.bookingUrl ?? '',
        contact: r.Contact ?? r.contact ?? '',
        city: r.City ?? r.city ?? '',
        province: r.Province ?? r.province ?? ''
      }))
      .filter(h => !regionKey || h.region === regionKey)
      .filter(h => !crit.type || (h.category || '').toLowerCase() === (crit.type || '').toLowerCase());

      renderList(items);
    }catch(e){
      console.error(e);
      errorBox.classList.remove('d-none');
      loading.classList.add('d-none');
    }
  })();

  // ---------- Render ----------
  function renderList(items){
    const loading = document.getElementById('loading');
    const list = document.getElementById('list');
    const empty = document.getElementById('empty');

    loading.classList.add('d-none');
    list.innerHTML = '';

    if (!items.length){
      empty.classList.remove('d-none');
      list.classList.add('d-none');
      return;
    }

    empty.classList.add('d-none');
    list.classList.remove('d-none');

    items.forEach(h => {
      const col = document.createElement('div');
      col.className = 'col-12';
      const validity = h.validity ? new Date(h.validity).toLocaleDateString('en-PH', { year:'numeric', month:'long', day:'2-digit' }) : '—';
      const url = h.bookingUrl?.trim() || h.website?.trim() || ('https://www.google.com/search?q=' + encodeURIComponent([h.name, h.city, h.province, h.region, 'Philippines', 'booking'].filter(Boolean).join(' ')));

      col.innerHTML = `
        <div class="card p-3">
          <div class="row g-3 align-items-center">
            <div class="col-12 col-md-4">
              <div class="thumb d-flex align-items-center justify-content-center text-muted">
                <span class="small">No image yet</span>
              </div>
            </div>
            <div class="col-12 col-md-8">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <h2 class="h6 mb-0">${escapeHtml(h.name)}</h2>
                <span class="badge text-bg-success">DOT Accredited</span>
              </div>
              <div class="small mt-1">
                ${(h.rating?`<strong>${escapeHtml(h.rating)}</strong> • `:'')}${escapeHtml(h.category || '')} • ${escapeHtml(h.region || '')}
              </div>
              ${h.validity ? `<div class="small muted">Accreditation valid until: ${escapeHtml(validity)}</div>` : ''}

              <div class="d-flex gap-2 mt-3 flex-wrap">
                <a class="btn btn-outline-primary btn-sm" href="${url}" target="_blank" rel="noopener">Check availability</a>
              </div>

              ${h.contact ? `<div class="small muted mt-2">Contact: ${escapeHtml(h.contact)}</div>` : ''}
            </div>
          </div>
        </div>
      `;
      list.appendChild(col);
    });

    // selection count is local (if you use it later)
    document.getElementById('selCount').textContent = (JSON.parse(localStorage.getItem('wf_stays') || '[]')).length;
  }

  function escapeHtml(s){
    return String(s ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }
</script>
</body>
</html>
