<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WayFrame | Available Stays</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
  body{background:#f5f7fb}
  .card{border-radius:16px}
  .pill{background:#eef5ff;color:#0b5ed7;border:1px solid #cfe2ff;border-radius:999px;padding:.25rem .6rem;font-weight:600}
  .muted{color:#6b7280}
  .thumb{width:100%;height:160px;object-fit:cover;border-radius:12px;background:linear-gradient(135deg,#e5ecff,#f5f7fb)}
  .fab-next{position:fixed; right:18px; bottom:18px; z-index:1050; box-shadow:0 10px 24px rgba(0,0,0,.15); border-radius:999px; padding:.9rem 1.2rem;}
  .fab-next[disabled]{opacity:.6; pointer-events:none}
</style>
</head>
<body>
<div class="container py-3">

  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h1 class="h5 mb-1">Available Stays</h1>
      <div id="destLine" class="muted small"></div>
    </div>
    <a href="module4.html" class="pill text-decoration-none">Edit filters</a>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-3">
      <div class="card p-3 sticky-top">
        <div class="fw-semibold mb-2">Your criteria</div>
        <div id="crit" class="small"></div>
        <hr/>
        <small class="text-muted">Establishments are from your curated DOT list in Google Sheets.</small>
        <hr/>
        <div class="small"><strong>Selected:</strong> <span id="selCount">0</span> stay(s)</div>
      </div>
    </div>

    <div class="col-12 col-lg-9">
      <div id="scopeNote" class="alert alert-info py-2 px-3 small d-none"></div>

      <div id="loading" class="text-center text-muted py-5">
        <div class="spinner-border" role="status" aria-hidden="true"></div>
        <div class="mt-2">Loading stays…</div>
      </div>

      <div id="list" class="row g-3 d-none"></div>
      <div id="empty" class="text-center text-muted py-5 d-none">No stays match your destination.</div>
      <div id="errorBox" class="alert alert-danger mt-3 d-none">
        Couldn’t load stays. Please try again.
      </div>
    </div>
  </div>
</div>

<button id="nextBtn" class="btn btn-primary fab-next" disabled>Next → Transport</button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ====== CONFIG: paste your Make webhook ======
  const MAKE_WEBHOOK = "https://hook.eu2.make.com/qp6e8tzwf1or6fy2ifyog53twiwwr25h";

  // ====== Read destination + criteria from Module 4 ======
  const dest = JSON.parse(localStorage.getItem('wf_destination') || '{}');
  const crit = JSON.parse(localStorage.getItem('wf_accomCriteria') || '{}');

  document.getElementById('destLine').textContent =
    dest.city
      ? `Near ${dest.city}${dest.province? ', ' + dest.province : ''}${dest.region? ', ' + dest.region : ''}`
      : 'Chosen area';

  document.getElementById('crit').innerHTML = `
    <div><strong>Type:</strong> ${crit.type || 'Any'}</div>
    <div><strong>Max price:</strong> ${crit.maxPrice ? '≤ ₱' + Number(crit.maxPrice).toLocaleString('en-PH') : 'Any'}</div>
    <div><strong>Room size:</strong> ${crit.roomSize || 'Any'}</div>
    <div><strong>Beds:</strong> ${crit.beds || 'Any'}</div>
  `;

  function normalizeRegionKey(s=''){
    const t = (s||'').toLowerCase();
    if (t.includes('ncr') || t.includes('metro manila')) return 'NCR';
    if (t.includes('iv-a') || t.includes('4a') || t.includes('calabarzon')) return 'Region 4A';
    if (t.includes('iv-b') || t.includes('4b') || t.includes('mimaropa')) return 'Region 4B';
    if (t.includes('region 5') || t.includes('bicol')) return 'Region 5';
    if (t.includes('region 6') || t.includes('western visayas')) return 'Region 6';
    if (t.includes('region 7') || t.includes('central visayas')) return 'Region 7';
    if (t.includes('region 12') || t.includes('soccsksargen')) return 'Region 12';
    if ((s||'').trim().toUpperCase() === 'NCR') return 'NCR';
    return s || null;
  }
  const regionKey = crit.regionKey || normalizeRegionKey(dest.region);
  const note = document.getElementById('scopeNote');
  if (regionKey){ note.classList.remove('d-none'); note.textContent = `Showing establishments in ${regionKey}.`; }

  // ====== Fetch stays (robust JSON handling) ======
  (async function loadStays(){
    const loading = document.getElementById('loading');
    const errorBox = document.getElementById('errorBox');
    try{
      const url = new URL(MAKE_WEBHOOK);
      if (regionKey) url.searchParams.set('region', regionKey);
      if (crit.type) url.searchParams.set('type', crit.type);

      const res = await fetch(url.toString(), { method: 'GET' });

      // Graceful handling for non-JSON replies
      const raw = await res.text();
      let rows;
      try { rows = JSON.parse(raw); }
      catch {
        console.warn('Non-JSON response from webhook:', raw);
        throw new Error('Non-JSON response from webhook');
      }
      if (!res.ok) throw new Error('HTTP ' + res.status);

      // Map to our fields
      const items = (rows || []).map(r => ({
        region: r.Region || r.region || '',
        name: r['Hotel Name'] || r.name || '',
        rating: r.Rating || r.rating || '',
        category: r.Category || r.category || '',
        validity: r.Validity || r.validity || '',
        website: r.Website || r.website || '',
        bookingUrl: r['Booking URL'] || r.bookingUrl || '',
        contact: r.Contact || r.contact || '',
        city: r.City || r.city || '',
        province: r.Province || r.province || ''
      }))
      .filter(h => !regionKey || h.region === regionKey)
      .filter(h => !crit.type || (h.category || '').toLowerCase() === crit.type.toLowerCase());

      renderList(items);
    }catch(err){
      console.error(err);
      errorBox.classList.remove('d-none');
      loading.classList.add('d-none');
    }
  })();

  function renderList(items){
    const loading = document.getElementById('loading');
    const list = document.getElementById('list');
    const empty = document.getElementById('empty');
    loading.classList.add('d-none');

    list.innerHTML = '';
    if (!items.length){
      empty.classList.remove('d-none');
      list.classList.add('d-none');
      return;
    }
    empty.classList.add('d-none');
    list.classList.remove('d-none');

    const chosen = JSON.parse(localStorage.getItem('wf_stays') || '[]');

    items.forEach(h => {
      const already = chosen.find(x => x.name === h.name);
      const col = document.createElement('div');
      col.className = 'col-12';
      const validity = h.validity ? new Date(h.validity).toLocaleDateString('en-PH', { year:'numeric', month:'long', day:'2-digit' }) : '—';
      const url = h.bookingUrl?.trim() || h.website?.trim() || googleSearchUrl(h.name);

      col.innerHTML = `
        <div class="card p-3">
          <div class="row g-3 align-items-center">
            <div class="col-12 col-md-4">
              <div class="thumb d-flex align-items-center justify-content-center text-muted">
                <span class="small">No image yet</span>
              </div>
            </div>
            <div class="col-12 col-md-8">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <h2 class="h6 mb-0">${h.name}</h2>
                <span class="badge bg-success-subtle border border-success-subtle text-success-emphasis">DOT Accredited</span>
              </div>
              <div class="small mt-1">
                ${(h.rating?`<strong>${h.rating}</strong> • `:'')}${h.category || ''} • ${h.region}
              </div>
              ${h.validity ? `<div class="small muted">Accreditation valid until: ${validity}</div>` : ''}

              <div class="d-flex gap-2 mt-3 flex-wrap">
                <a class="btn btn-outline-primary btn-sm" href="${url}" target="_blank" rel="noopener">Check availability</a>
                <button class="btn ${already ? 'btn-success' : 'btn-primary'} btn-sm" data-name="${h.name}">
                  ${already ? 'Added' : 'Add to plan'}
                </button>
              </div>
              ${h.contact ? `<div class="small muted mt-2">Contact: ${h.contact}</div>` : ''}
            </div>
          </div>
        </div>
      `;
      col.querySelector('button.btn').addEventListener('click', () => addToPlan(h));
      list.appendChild(col);
    });

    updateSelectionCount();
    syncNextButton();
  }

  function googleSearchUrl(name){
    const q = [name, 'Philippines', 'booking'].join(' ');
    return 'https://www.google.com/search?q=' + encodeURIComponent(q);
  }

  function addToPlan(hotel){
    const arr = JSON.parse(localStorage.getItem('wf_stays') || '[]');
    if (!arr.find(x => x.name === hotel.name)){
      arr.push({ name: hotel.name, region: hotel.region, addedAt: Date.now(), booking: null });
      localStorage.setItem('wf_stays', JSON.stringify(arr));
      updateSelectionCount();
      syncNextButton();
    }
  }

  function updateSelectionCount(){
    const count = (JSON.parse(localStorage.getItem('wf_stays') || '[]')).length;
    document.getElementById('selCount').textContent = count;
  }

  const nextBtn = document.getElementById('nextBtn');
  nextBtn.addEventListener('click', () => {
    const progress = JSON.parse(localStorage.getItem('wf_progress') || '{}');
    localStorage.setItem('wf_progress', JSON.stringify({ ...progress, m4_done: true }));
    window.location.href = 'module5.html';
  });

  function syncNextButton(){
    const count = (JSON.parse(localStorage.getItem('wf_stays') || '[]')).length;
    nextBtn.disabled = count === 0;
  }
</script>
</body>
</html>
