<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WayFrame - Destination (Module 2)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Leaflet Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    :root {
      --bg:#f9f9f9; --panel:#fff; --primary:#007bff; --primary-dark:#0056b3;
      --muted:#6c757d; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.12);
    }
    html, body { height:100%; margin:0; background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    #map { position:fixed; inset:0; }

    .panel {
      position:fixed; right:24px; top:24px; width:420px; max-width:calc(100% - 48px);
      background:var(--panel); border-radius:var(--radius); box-shadow:var(--shadow);
      display:flex; flex-direction:column; overflow:hidden; transition:height 0.25s ease;
    }
    .panel-header {
      padding:1rem 1.25rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;
    }
    .panel-header h2 { margin:0; font-size:1.1rem; }
    .panel-header button {
      border:none; background:none; font-size:1.2rem; cursor:pointer; line-height:1;
    }
    .panel-body { padding:1rem 1.25rem 1.25rem; }
    .panel.collapsed { height:48px; }
    .panel.collapsed .panel-body { display:none; }

    label { display:block; margin-top:.85rem; font-weight:600; font-size:.92rem; }
    input[type="text"] {
      width:100%; padding:.8rem; margin-top:.4rem; border-radius:8px; border:1px solid #cfd6e4; outline:none;
    }
    .hint { color:var(--muted); font-size:.85rem; margin-top:.35rem; }
    .pill {
      display:inline-flex; align-items:center; gap:.5rem; background:#f1f5f9; border:1px solid #e2e8f0;
      border-radius:999px; padding:.35rem .7rem; font-size:.85rem; color:#0f172a;
    }
    .inline { display:flex; gap:.6rem; align-items:center; margin:.75rem 0; flex-wrap:wrap; }
    .actions { display:flex; gap:.6rem; padding:.9rem 0 0 0; }
    .btn { flex:1; padding:.9rem 1rem; border:none; border-radius:10px; cursor:pointer; font-weight:700; }
    .btn-primary { background:var(--primary); color:#fff; }
    .btn-primary:hover { background:var(--primary-dark); }
    .btn-secondary { background:#e9ecef; }

    @media (max-width: 720px) {
      .panel { left:0; right:0; bottom:0; top:auto; width:100%; border-radius:16px 16px 0 0; }
    }

    .leaflet-control-geocoder-form input { min-width: 220px; }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="panel" role="dialog" aria-modal="true" aria-label="Select Destination">
    <div class="panel-header">
      <h2>Select Destination</h2>
      <button id="togglePanel" title="Minimize">&#x25BC;</button>
    </div>
    <div class="panel-body">
      <p class="hint">Search or tap the map to set your destination. Weâ€™ll drop a pin and auto-fill details. You can still edit them.</p>

      <div class="inline">
        <span class="pill" id="coordPill">No point selected</span>
        <button class="btn btn-secondary" type="button" id="recenterPH">Re-center PH</button>
      </div>

      <label for="city">City / Town</label>
      <input type="text" id="city" placeholder="e.g., Tagaytay"/>

      <label for="province">Province</label>
      <input type="text" id="province" placeholder="e.g., Cavite"/>

      <label for="region">Region</label>
      <input type="text" id="region" placeholder="e.g., CALABARZON (Region IV-A)"/>

      <div class="actions">
        <button class="btn btn-primary" type="button" id="nextBtn">Next</button>
      </div>
    </div>
  </div>

  <script>
    // Guard: must come from Module 1
    (function guard(){
      const name = localStorage.getItem('userName');
      const email = localStorage.getItem('userEmail');
      if (!name || !email) {
        alert("Please start at the beginning.");
        window.location.href = "index.html";
      }
    })();

    // Map init
    const PH_CENTER = [12.8797, 121.7740];
    const map = L.map('map', { zoomControl: true }).setView(PH_CENTER, 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

    // Search control
    const geocoder = L.Control.geocoder({ defaultMarkGeocode: false }).addTo(map);
    geocoder.on('markgeocode', function(e) {
      const center = e.geocode.center;
      map.fitBounds(e.geocode.bbox);
      setMarker(center.lat, center.lng, true);
    });

    let marker = null;
    let selected = null;
    function setMarker(lat, lng, doReverse = true) {
      selected = { lat, lng };
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);
      updateCoordPill();
      if (doReverse) reverseGeocode(lat, lng).then(fillFields).catch(()=>{});
    }
    function updateCoordPill(){
      document.getElementById('coordPill').textContent = selected
        ? `Selected: ${selected.lat.toFixed(5)}, ${selected.lng.toFixed(5)}`
        : 'No point selected';
    }

    map.on('click', (e)=> setMarker(e.latlng.lat, e.latlng.lng, true));
    document.getElementById('recenterPH').onclick = ()=> map.setView(PH_CENTER, 6);

    function reverseGeocode(lat, lon){
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
      return fetch(url).then(r => r.ok ? r.json() : Promise.reject())
        .then(j => j.address || {});
    }
    function fillFields(addr){
      document.getElementById('city').value =
        addr.city || addr.town || addr.municipality || addr.village || addr.locality || document.getElementById('city').value;
      document.getElementById('province').value =
        addr.state || addr.county || addr.region || document.getElementById('province').value;
      document.getElementById('region').value =
        addr.region || addr.state_district || document.getElementById('region').value;
    }

    (function prefill(){
      const saved = JSON.parse(localStorage.getItem('wf_destination') || '{}');
      if (!saved) return;
      if (saved.city) document.getElementById('city').value = saved.city;
      if (saved.province) document.getElementById('province').value = saved.province;
      if (saved.region) document.getElementById('region').value = saved.region;
      if (saved.lat && saved.lng) {
        setMarker(saved.lat, saved.lng, false);
        map.setView([saved.lat, saved.lng], 12);
      }
    })();

    document.getElementById('nextBtn').onclick = () => {
      if (!selected) {
        alert('Tap the map or search to choose a point first.');
        return;
      }
      const city = document.getElementById('city').value.trim();
      const province = document.getElementById('province').value.trim();
      const region = document.getElementById('region').value.trim();

      if (!city || !province || !region) {
        if (!confirm('Some fields are empty. Proceed with coordinates only?')) return;
      }

      localStorage.setItem('wf_destination', JSON.stringify({
        city: city || null,
        province: province || null,
        region: region || null,
        lat: selected.lat,
        lng: selected.lng,
        method: 'map'
      }));
      const progress = JSON.parse(localStorage.getItem('wf_progress') || '{}');
      localStorage.setItem('wf_progress', JSON.stringify({ ...progress, m2: true }));

      window.location.href = 'module3.html';
    };

    // Collapse/expand
    const panel = document.querySelector('.panel');
    const toggleBtn = document.getElementById('togglePanel');
    let collapsed = false;
    toggleBtn.addEventListener('click', () => {
      collapsed = !collapsed;
      panel.classList.toggle('collapsed', collapsed);
      toggleBtn.innerHTML = collapsed ? '&#x25B2;' : '&#x25BC;';
    });
  </script>
</body>
</html>
