<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WayFrame - Destination (Module 2)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Leaflet Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    :root{
      --bg:#f9f9fb; --panel:#fff; --primary:#1677ff; --primary-dark:#0f62d6;
      --muted:#6b7280; --line:#e5e7eb; --shadow:0 10px 30px rgba(0,0,0,.12);
      --radius:16px; --radius-sm:12px; --padX:16px; --padY:14px;
    }
    *{ box-sizing:border-box }
    html,body{ height:100%; margin:0; background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif }

    /* Map */
    #map{ position:fixed; inset:0 }

    /* Panel */
    .panel{
      position:fixed; z-index:1000;
      right: clamp(12px, 3vw, 24px);
      top: clamp(12px, 3vw, 24px);
      width: min(440px, calc(100% - 24px));
      background:var(--panel); border-radius:var(--radius); box-shadow:var(--shadow);
      overflow:hidden; transition:height .25s ease;
    }
    .panel-header{
      padding: 12px var(--padX);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
    }
    .panel-header h2{ margin:0; font-size:1.05rem; letter-spacing:.2px }
    .panel-header button{ border:none; background:none; font-size:1.2rem; cursor:pointer; line-height:1 }

    .panel-body{ padding: 10px var(--padX) 14px var(--padX) }
    .panel.collapsed{ height:48px }
    .panel.collapsed .panel-body{ display:none }

    /* Fields */
    .field{ margin-top:10px }
    label{ display:block; font-size:.92rem; font-weight:600; margin-bottom:6px }
    input[type="text"]{
      width:100%;
      height: 42px;
      padding: 0 12px;
      border:1px solid var(--line);
      border-radius: var(--radius-sm);
      background:#fff;
      outline:none;
      font-size:.98rem;
    }
    input[type="text"]::placeholder{ color:#9ca3af }
    input[type="text"]:focus{ border-color:#cbd5e1; box-shadow:0 0 0 3px rgba(22,119,255,.08) }

    .hint{ color:var(--muted); font-size:.86rem; margin-top:6px }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0 }
    .pill{
      display:inline-flex; align-items:center; padding:6px 10px; gap:6px;
      background:#f3f4f6; border:1px solid #e5e7eb; border-radius:999px; font-size:.86rem; color:#111827;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:100%; height:44px; border:none; border-radius:12px; cursor:pointer; font-weight:700;
    }
    .btn-primary{ background:var(--primary); color:#fff }
    .btn-primary:hover{ background:var(--primary-dark) }
    .btn-secondary{ background:#eef2f7; color:#111827 }

    /* Geocoder control spacing so it doesn't hide behind panel */
    .leaflet-top.leaflet-left{ top: 12px }
    .leaflet-control-geocoder-form input{ min-width: 210px }

    /* Mobile bottom sheet */
    @media (max-width: 720px){
      .panel{
        left: env(safe-area-inset-left);
        right: env(safe-area-inset-right);
        bottom: env(safe-area-inset-bottom);
        top: auto;
        width: auto;
        border-radius: 16px 16px 0 0;
      }
      .panel-body{ padding: 10px 14px 16px 14px }
      .row{ gap:8px }
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="panel" role="dialog" aria-modal="true" aria-label="Select Destination">
    <div class="panel-header">
      <h2>Select Destination</h2>
      <button id="togglePanel" title="Minimize" aria-label="Toggle panel">&#x25BC;</button>
    </div>

    <div class="panel-body">
      <p class="hint">Search or tap the map to set your destination. We’ll drop a pin and auto‑fill details. You can still edit them.</p>

      <div class="row">
        <span class="pill" id="coordPill">Selected: —</span>
        <button class="btn btn-secondary" type="button" id="recenterPH" style="width:auto; padding:0 14px; height:36px; border-radius:10px;">Re-center PH</button>
      </div>

      <div class="field">
        <label for="city">City / Town</label>
        <input type="text" id="city" placeholder="e.g., Tagaytay">
      </div>

      <div class="field">
        <label for="province">Province</label>
        <input type="text" id="province" placeholder="e.g., Cavite">
      </div>

      <div class="field">
        <label for="region">Region</label>
        <input type="text" id="region" placeholder="e.g., CALABARZON (Region IV‑A)">
      </div>

      <div class="field" style="margin-top:14px">
        <button class="btn btn-primary" type="button" id="nextBtn">Next</button>
      </div>
    </div>
  </div>

  <script>
    // Guard: must come from Module 1
    (function guard(){
      const name = localStorage.getItem('userName');
      const email = localStorage.getItem('userEmail');
      if (!name || !email) {
        alert("Please start at the beginning.");
        window.location.href = "index.html";
      }
    })();

    // Map init
    const PH_CENTER = [12.8797, 121.7740];
    const map = L.map('map', { zoomControl: true }).setView(PH_CENTER, 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

    // Geocoder (search)
    const geocoder = L.Control.geocoder({ defaultMarkGeocode: false }).addTo(map);
    geocoder.on('markgeocode', function(e) {
      const { center, bbox } = e.geocode;
      map.fitBounds(bbox);
      setMarker(center.lat, center.lng, true);
    });

    // Marker + state
    let marker = null;
    let selected = null;
    function setMarker(lat, lng, doReverse = true) {
      selected = { lat, lng };
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);
      updateCoordPill();
      if (doReverse) reverseGeocode(lat, lng).then(fillFields).catch(()=>{});
    }
    function updateCoordPill(){
      const pill = document.getElementById('coordPill');
      pill.textContent = selected ? `Selected: ${selected.lat.toFixed(5)}, ${selected.lng.toFixed(5)}` : 'Selected: —';
    }

    map.on('click', (e)=> setMarker(e.latlng.lat, e.latlng.lng, true));
    document.getElementById('recenterPH').onclick = ()=> map.setView(PH_CENTER, 6);

    // Reverse geocode
    function reverseGeocode(lat, lon){
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
      return fetch(url).then(r => r.ok ? r.json() : Promise.reject())
        .then(j => j.address || {});
    }
    function fillFields(addr){
      document.getElementById('city').value =
        addr.city || addr.town || addr.municipality || addr.village || addr.locality || document.getElementById('city').value;
      document.getElementById('province').value =
        addr.state || addr.county || addr.region || document.getElementById('province').value;
      document.getElementById('region').value =
        addr.region || addr.state_district || document.getElementById('region').value;
    }

    // Prefill on return
    (function prefill(){
      const saved = JSON.parse(localStorage.getItem('wf_destination') || '{}');
      if (!saved) return;
      if (saved.city) document.getElementById('city').value = saved.city;
      if (saved.province) document.getElementById('province').value = saved.province;
      if (saved.region) document.getElementById('region').value = saved.region;
      if (saved.lat && saved.lng) {
        setMarker(saved.lat, saved.lng, false);
        map.setView([saved.lat, saved.lng], 12);
      }
    })();

    // Next
    document.getElementById('nextBtn').onclick = () => {
      if (!selected) { alert('Tap the map or search to choose a point first.'); return; }
      const city = document.getElementById('city').value.trim();
      const province = document.getElementById('province').value.trim();
      const region = document.getElementById('region').value.trim();

      if (!city || !province || !region) {
        if (!confirm('Some fields are empty. Proceed with coordinates only?')) return;
      }

      localStorage.setItem('wf_destination', JSON.stringify({
        city: city || null, province: province || null, region: region || null,
        lat: selected.lat, lng: selected.lng, method: 'map'
      }));
      const progress = JSON.parse(localStorage.getItem('wf_progress') || '{}');
      localStorage.setItem('wf_progress', JSON.stringify({ ...progress, m2: true }));
      window.location.href = 'module3.html';
    };

    // Collapse/expand
    const panel = document.querySelector('.panel');
    const toggleBtn = document.getElementById('togglePanel');
    let collapsed = false;
    toggleBtn.addEventListener('click', () => {
      collapsed = !collapsed;
      panel.classList.toggle('collapsed', collapsed);
      toggleBtn.innerHTML = collapsed ? '&#x25B2;' : '&#x25BC;';
    });
  </script>
</body>
</html>
